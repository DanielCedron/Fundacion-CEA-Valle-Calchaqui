<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transferencia Flash Pro</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root { --primary: #007aff; --success: #00ff88; --bg: #121212; --card-bg: #1e1e1e; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: #e0e0e0; margin: 0; padding: 20px; overflow-x: hidden; }
        
        /* Notificaciones */
        #notification-container { position: fixed; top: 20px; right: 20px; z-index: 1000; }
        .toast { background: var(--card-bg); border-left: 5px solid var(--success); color: white; padding: 15px 25px; border-radius: 8px; margin-bottom: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); animation: slideIn 0.5s ease forwards; }

        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        .card { background: var(--card-bg); padding: 30px; border-radius: 24px; max-width: 600px; margin: 20px auto; border: 1px solid #333; transition: all 0.3s ease; }
        #qrcode { background: white; padding: 15px; display: inline-block; border-radius: 12px; margin: 20px 0; }
        
        .waiting-msg { display: none; padding: 40px 0; }
        .spinner { border: 3px solid rgba(255,255,255,0.1); border-top: 3px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Galer√≠a Estilo Naipes */
        #gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 20px; margin-top: 30px; }
        .img-card { background: #2a2a2a; border-radius: 12px; padding: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); transform: rotate(calc(var(--r) * 1deg)); transition: transform 0.2s; position: relative; }
        .img-card:hover { transform: rotate(0deg) scale(1.05); z-index: 10; }
        .img-card img { width: 100%; height: 160px; object-fit: cover; border-radius: 8px; }
        
        .btn { background: var(--primary); color: white; border: none; padding: 18px; border-radius: 14px; font-weight: bold; cursor: pointer; width: 100%; font-size: 16px; }
        input[type="file"] { display: none; }
        #status { font-weight: 600; color: var(--primary); margin-bottom: 20px; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="notification-container"></div>

    <h2>‚ö° Transferencia Directa</h2>
    <div id="status">Iniciando sistema...</div>

    <div id="pc-view" class="card" style="display:none;">
        <div id="qr-section">
            <p>Escanea este c√≥digo para empezar a enviar im√°genes:</p>
            <div id="qrcode"></div>
        </div>
        
        <div id="waiting-section" class="waiting-msg">
            <div class="spinner"></div>
            <h3>Dispositivo conectado ‚úÖ</h3>
            <p>Esperando que env√≠es fotos desde tu celular...</p>
        </div>

        <div id="gallery"></div>
    </div>

    <div id="mobile-view" class="card" style="display:none;">
        <div id="conn-status">Buscando PC...</div>
        <br>
        <label class="btn" id="upload-label" style="opacity: 0.5; pointer-events: none;">
            SELECCIONAR FOTOS
            <input type="file" id="file-input" accept="image/*" multiple>
        </label>
        <p id="send-log" style="margin-top: 20px; font-size: 14px; color: #aaa;"></p>
    </div>

    <script>
        let baseID = window.location.hash.substring(1);
        if (!baseID) {
            baseID = Math.random().toString(36).substring(2, 8);
            window.location.hash = baseID;
        }

        const isMobile = /iPhone|Android/i.test(navigator.userAgent);
        const myID = isMobile ? 'mob-' + baseID + Math.floor(Math.random()*100) : 'pc-' + baseID;
        const targetPCID = 'pc-' + baseID;

        const peer = new Peer(myID);

        peer.on('open', () => {
            document.getElementById('status').innerText = "Sistema Listo";
            if (isMobile) setupMobile(); else setupPC();
        });

        function showNotification(text) {
            const container = document.getElementById('notification-container');
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerText = text;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }

        function setupPC() {
            document.getElementById('pc-view').style.display = 'block';
            new QRCode(document.getElementById("qrcode"), { text: window.location.href, width: 200, height: 200 });

            peer.on('connection', (conn) => {
                // Esconder QR y mostrar mensaje de espera
                document.getElementById('qr-section').classList.add('hidden');
                document.getElementById('waiting-section').style.display = 'block';
                document.getElementById('status').innerText = "V√≠nculo Establecido";

                conn.on('data', (data) => {
                    const blob = new Blob([data.file], { type: data.type });
                    const url = URL.createObjectURL(blob);
                    
                    // Crear naipe visual
                    const card = document.createElement('div');
                    card.className = 'img-card';
                    card.style.setProperty('--r', (Math.random() * 6 - 3).toFixed(2));
                    card.innerHTML = `<img src="${url}">`;
                    document.getElementById('gallery').prepend(card);
                    
                    // Descarga autom√°tica
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = data.name || "transfer_" + Date.now();
                    a.click();

                    showNotification("üì∏ ¬°IMAGEN CARGADA CON √âXITO!");
                });
            });
        }

        function setupMobile() {
            document.getElementById('mobile-view').style.display = 'block';
            const connStatus = document.getElementById('conn-status');
            const conn = peer.connect(targetPCID);
            
            conn.on('open', () => {
                connStatus.innerText = "Conectado a PC ‚úÖ";
                const label = document.getElementById('upload-label');
                label.style.opacity = "1";
                label.style.pointerEvents = "auto";

                document.getElementById('file-input').onchange = async (e) => {
                    const files = Array.from(e.target.files);
                    document.getElementById('send-log').innerText = `Enviando ${files.length} fotos...`;
                    for (let file of files) {
                        await conn.send({ file: file, type: file.type, name: file.name });
                    }
                    document.getElementById('send-log').innerText = "¬°Enviado!";
                };
            });
        }
    </script>
</body>
</html>