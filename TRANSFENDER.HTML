<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transferencia Flash Pro</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root { --primary: #007aff; --success: #00ff88; --bg: #121212; --card-bg: #1e1e1e; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: #e0e0e0; margin: 0; padding: 20px; }
        
        #notification-container { position: fixed; top: 20px; right: 20px; z-index: 1000; pointer-events: none; }
        .toast { background: #333; border-left: 5px solid var(--success); color: white; padding: 12px 20px; border-radius: 8px; margin-bottom: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

        .card { background: var(--card-bg); padding: 25px; border-radius: 20px; max-width: 600px; margin: 10px auto; border: 1px solid #333; }
        #qrcode { background: white; padding: 10px; display: inline-block; border-radius: 10px; }
        
        #waiting-area { padding: 20px; color: #888; border: 2px dashed #333; border-radius: 15px; margin-top: 10px; }
        
        #gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; margin-top: 20px; }
        .img-card { background: #2a2a2a; border-radius: 10px; padding: 5px; box-shadow: 0 4px 10px rgba(0,0,0,0.5); position: relative; }
        .img-card img { width: 100%; height: 150px; object-fit: cover; border-radius: 6px; }
        
        .btn { background: var(--primary); color: white; border: none; padding: 15px; border-radius: 12px; font-weight: bold; cursor: pointer; width: 100%; }
        input[type="file"] { display: none; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="notification-container"></div>

    <div id="pc-view" class="card" style="display:none;">
        <div id="status-tag" style="font-size: 12px; color: var(--primary);">Iniciando...</div>
        
        <div id="qr-section">
            <p>Escanea para vincular:</p>
            <div id="qrcode"></div>
        </div>
        
        <div id="waiting-area" class="hidden">
            <h3>Dispositivo conectado ‚úÖ</h3>
            <p>Env√≠a fotos desde el celular para verlas aqu√≠.</p>
        </div>

        <div id="gallery"></div>
    </div>

    <div id="mobile-view" class="card" style="display:none;">
        <div id="conn-status">Buscando conexi√≥n...</div>
        <br>
        <label class="btn" id="upload-label" style="opacity: 0.4; pointer-events: none;">
            SELECCIONAR FOTOS
            <input type="file" id="file-input" accept="image/*" multiple>
        </label>
        <p id="send-log" style="font-size: 12px; color: #777; margin-top: 15px;"></p>
    </div>

    <script>
        // --- CONFIGURACI√ìN DE REDIRECCI√ìN Y SESI√ìN ---
        const URL_PROYECTO = "https://danielcedron.github.io/Fundacion-CEA-Valle-Calchaqui/TRANSFENDER.HTML";
        const isMobile = /iPhone|Android/i.test(navigator.userAgent);

        // 1. Gesti√≥n de ID Persistente
        let baseID = window.location.hash.substring(1);
        
        if (!baseID) {
            // Si no hay ID en la URL, buscamos en la memoria del navegador
            baseID = localStorage.getItem('transfender_session');
            
            if (!baseID) {
                // Si es la primera vez absoluta, generamos uno nuevo
                baseID = Math.random().toString(36).substring(2, 8);
                localStorage.setItem('transfender_session', baseID);
            }
            // Asignamos el ID a la URL actual
            window.location.hash = baseID;
        } else {
            // Si ven√≠a en la URL, actualizamos la memoria local para recordar esta sesi√≥n
            localStorage.setItem('transfender_session', baseID);
        }

        // 2. Redirecci√≥n Autom√°tica (Solo para PC ejecutando archivo local)
        // Si NO estamos en GitHub Pages Y NO es un celular -> Redirigir a la web oficial con el ID correcto
        if (!window.location.hostname.includes("github.io") && !isMobile) {
            console.log("Redirigiendo a la versi√≥n online...");
            window.location.href = URL_PROYECTO + "#" + baseID;
        }

        // --- INICIO DE PEERJS Y L√ìGICA DE TRANSFERENCIA ---
        
        const pcPeerID = 'pc-' + baseID;
        const mobilePeerID = 'mob-' + baseID + Math.floor(Math.random() * 1000);
        
        const peer = new Peer(isMobile ? mobilePeerID : pcPeerID);

        peer.on('open', () => {
            if (isMobile) setupMobile(); else setupPC();
        });

        function notify(msg) {
            const t = document.createElement('div');
            t.className = 'toast';
            t.innerText = msg;
            document.getElementById('notification-container').appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }

        // --- L√ìGICA PC ---
        function setupPC() {
            document.getElementById('pc-view').style.display = 'block';
            document.getElementById('status-tag').innerText = "ESPERANDO V√çNCULO";
            // Generar QR con la URL del proyecto + el ID actual
            const qrUrl = URL_PROYECTO + "#" + baseID;
            new QRCode(document.getElementById("qrcode"), { text: qrUrl, width: 180, height: 180 });

            peer.on('connection', (conn) => {
                document.getElementById('qr-section').classList.add('hidden');
                document.getElementById('waiting-area').classList.remove('hidden');
                document.getElementById('status-tag').innerText = "CONECTADO";

                conn.on('data', (data) => {
                    // Si llega la primera imagen, ocultar el cuadro de "Esperando"
                    document.getElementById('waiting-area').classList.add('hidden');
                    
                    const blob = new Blob([data.file], { type: data.type });
                    const url = URL.createObjectURL(blob);
                    
                    const card = document.createElement('div');
                    card.className = 'img-card';
                    card.innerHTML = `<img src="${url}">`;
                    document.getElementById('gallery').prepend(card);
                    
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = data.name || "foto.jpg";
                    a.click();
                    notify("üì• Imagen descargada");
                });

                conn.on('close', () => {
                    document.getElementById('qr-section').classList.remove('hidden');
                    document.getElementById('waiting-area').classList.add('hidden');
                    document.getElementById('status-tag').innerText = "DESCONECTADO";
                });
            });
        }

        // --- L√ìGICA M√ìVIL ---
        function setupMobile() {
            document.getElementById('mobile-view').style.display = 'block';
            const log = document.getElementById('send-log');
            let activeConn = null;

            function connect() {
                const conn = peer.connect(pcPeerID);
                
                conn.on('open', () => {
                    activeConn = conn;
                    document.getElementById('conn-status').innerText = "Conectado a PC ‚úÖ";
                    document.getElementById('upload-label').style.opacity = "1";
                    document.getElementById('upload-label').style.pointerEvents = "auto";
                });

                conn.on('close', () => {
                    activeConn = null;
                    document.getElementById('conn-status').innerText = "PC desconectada. Reintentando...";
                    setTimeout(connect, 2000); 
                });
                
                conn.on('error', () => setTimeout(connect, 2000));
            }

            connect();

            document.getElementById('file-input').onchange = async (e) => {
                if (!activeConn) return alert("No hay conexi√≥n con la PC");
                const files = Array.from(e.target.files);
                log.innerText = `Enviando ${files.length} archivos...`;
                
                for (let file of files) {
                    await activeConn.send({ file: file, type: file.type, name: file.name });
                }
                log.innerText = "¬°Enviado con √©xito!";
            };
        }
    </script>
</body>
</html>