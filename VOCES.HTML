<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Shifter Pro - Estable</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: #1a1a2e;
            color: #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
        }
        .container {
            background-color: #16213e;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            width: 90%;
            max-width: 500px;
            text-align: center;
        }
        .control-group {
            margin: 20px 0;
            text-align: left;
            background: #0f3460;
            padding: 15px;
            border-radius: 8px;
        }
        label { display: flex; justify-content: space-between; font-weight: bold; margin-bottom: 10px; }
        input[type="range"] { width: 100%; cursor: pointer; }
        .btn-group { display: flex; gap: 10px; justify-content: center; margin-top: 20px; }
        button {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            background-color: #e94560;
            color: white;
        }
        button:hover { background-color: #d13b53; }
        button:disabled { background-color: #555; opacity: 0.6; }
        #status { font-size: 0.9em; color: #4ecca3; margin-top: 10px; }
        #download-link { display: none; margin-top: 20px; color: #4ecca3; font-weight: bold; text-decoration: none; border: 1px solid #4ecca3; padding: 10px; border-radius: 5px; }
    </style>
</head>
<body>

    <div class="container">
        <h2>üéôÔ∏è Voice Shifter Pro</h2>
        <p style="font-size: 0.8em; color: #888;">Carga un audio para empezar</p>
        
        <input type="file" id="audio-upload" accept="audio/*">
        
        <div class="control-group">
            <label>Subir Tono (Pitch): <span id="pitch-val">4</span></label>
            <input type="range" id="pitch-slider" min="0" max="12" step="1" value="4">
        </div>

        <div class="control-group">
            <label>Quitar Graves (EQ Low): <span id="eq-val">-15 dB</span></label>
            <input type="range" id="eq-slider" min="-40" max="0" step="1" value="-15">
        </div>

        <div class="btn-group">
            <button id="btn-play" disabled>‚ñ∂Ô∏è Reproducir</button>
            <button id="btn-record" disabled>üî¥ Grabar</button>
        </div>
        
        <div id="status">Esperando archivo...</div>
        <a id="download-link" href="#" download="voz_modificada.webm">‚¨áÔ∏è Descargar Grabaci√≥n</a>
    </div>

    <script>
        let player, pitchShift, eq, recorder;
        let isRecording = false;

        const uploadInput = document.getElementById('audio-upload');
        const playBtn = document.getElementById('btn-play');
        const recordBtn = document.getElementById('btn-record');
        const downloadLink = document.getElementById('download-link');
        const statusText = document.getElementById('status');
        
        // Elementos de la interfaz
        const pitchSlider = document.getElementById('pitch-slider');
        const eqSlider = document.getElementById('eq-slider');

        // Inicializar efectos
        function setupEffects() {
            if (!pitchShift) {
                pitchShift = new Tone.PitchShift({ pitch: parseInt(pitchSlider.value) }).toDestination();
                eq = new Tone.EQ3({ low: parseInt(eqSlider.value), mid: 0, high: 2 }).connect(pitchShift);
                recorder = new Tone.Recorder();
                pitchShift.connect(recorder); // Conectamos la salida final al grabador
            }
        }

        uploadInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            statusText.innerText = "Cargando audio...";
            
            // IMPORTANTE: Esto despierta al AudioContext tras el gesto del usuario
            await Tone.start();
            setupEffects();

            const url = URL.createObjectURL(file);
            
            if (player) player.dispose();
            
            player = new Tone.Player({
                url: url,
                onload: () => {
                    playBtn.disabled = false;
                    recordBtn.disabled = false;
                    statusText.innerText = "‚úÖ Audio listo para procesar";
                },
                onerror: () => {
                    statusText.innerText = "‚ùå Error al cargar audio";
                }
            }).connect(eq);
        });

        playBtn.addEventListener('click', async () => {
            await Tone.start(); // Aseguramos que el audio est√© activo
            if (player.state === "started") {
                player.stop();
                playBtn.innerText = "‚ñ∂Ô∏è Reproducir";
            } else {
                player.start();
                playBtn.innerText = "‚èπÔ∏è Detener";
            }
        });

        recordBtn.addEventListener('click', async () => {
            await Tone.start();
            if (!isRecording) {
                recorder.start();
                player.start();
                isRecording = true;
                recordBtn.innerText = "‚èπÔ∏è Parar y Guardar";
                statusText.innerText = "üî¥ Grabando...";
                playBtn.disabled = true;
                downloadLink.style.display = "none";
            } else {
                const recording = await recorder.stop();
                const url = URL.createObjectURL(recording);
                downloadLink.href = url;
                downloadLink.style.display = "block";
                isRecording = false;
                recordBtn.innerText = "üî¥ Grabar";
                statusText.innerText = "‚úÖ Grabaci√≥n lista";
                playBtn.disabled = false;
                player.stop();
            }
        });

        // Sliders en tiempo real
        pitchSlider.oninput = (e) => {
            document.getElementById('pitch-val').innerText = e.target.value;
            if (pitchShift) pitchShift.pitch = e.target.value;
        };
        eqSlider.oninput = (e) => {
            document.getElementById('eq-val').innerText = e.target.value + " dB";
            if (eq) eq.low.value = e.target.value;
        };

    </script>
</body>
</html>
